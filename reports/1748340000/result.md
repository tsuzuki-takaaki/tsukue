<https://zenn.dev/meihei/scraps/61a844ac783d19> を見て点数が出せることがわかったのでちょっとやってみたくなって試したものたち

## 初期設定

- /etc/hostsで名前解決用の設定

```
# isucon14p
52.197.34.191 isuride.xiv.isucon.net
```

- matchingクライアントで証明書期限切れを許可(insecure)
  - curlのkオプションを追加
    - こいつが弾かれているとスコアは永遠に0になる
  - unitファイルを変えたので`daemon-reload`
- 静的ファイルチェックの失敗を許可
  - benchを実行する際に`--skip-static-sanity-check`を追加

```sh
./bench run . run --addr 127.0.0.1:443 --target https://isuride.xiv.isucon.net --payment-url http://127.0.0.1:12346 --payment-bind-port 12346 --skip-static-sanity-check
```

## 初期スコア

1063

## profile

- 各ページのパフォーマンスを確認

```log
+-------+-----+------+-----+-----+-----+--------+---------------------------------+-------+-------+----------+-------+-------+-------+-------+--------+-----------+-----------+------------+-----------+
| COUNT | 1XX | 2XX  | 3XX | 4XX | 5XX | METHOD |               URI               |  MIN  |  MAX  |   SUM    |  AVG  |  P90  |  P95  |  P99  | STDDEV | MIN(BODY) | MAX(BODY) | SUM(BODY)  | AVG(BODY) |
+-------+-----+------+-----+-----+-----+--------+---------------------------------+-------+-------+----------+-------+-------+-------+-------+--------+-----------+-----------+------------+-----------+
| 7938  | 0   | 7924 | 0   | 14  | 0   | GET    | /api/chair/notification         | 0.000 | 2.132 | 1063.127 | 0.134 | 0.275 | 0.301 | 0.368 | 0.130  | 0.000     | 267.000   | 886215.000 | 111.642   |
| 1878  | 0   | 1865 | 0   | 13  | 0   | GET    | /api/app/notification           | 0.008 | 1.992 | 617.321  | 0.329 | 0.477 | 0.521 | 0.614 | 0.122  | 0.000     | 438.000   | 718741.000 | 382.716   |
| 2304  | 0   | 2304 | 0   | 0   | 0   | POST   | /api/chair/coordinate           | 0.078 | 2.047 | 447.288  | 0.194 | 0.238 | 0.262 | 0.360 | 0.129  | 29.000    | 29.000    | 66816.000  | 29.000    |
| 43    | 0   | 43   | 0   | 0   | 0   | GET    | /api/owner/chairs               | 0.171 | 8.427 | 260.792  | 6.065 | 8.213 | 8.371 | 8.427 | 1.755  | 575.000   | 18979.000 | 52022.000  | 1209.814  |
| 32    | 0   | 32   | 0   | 0   | 0   | GET    | /api/app/nearby-chairs          | 4.102 | 7.690 | 180.574  | 5.643 | 6.961 | 7.185 | 7.690 | 0.982  | 42.000    | 914.000   | 11242.000  | 351.312   |
| 21    | 0   | 21   | 0   | 0   | 0   | POST   | /api/chair/activity             | 0.064 | 2.172 | 23.847   | 1.136 | 2.127 | 2.131 | 2.172 | 0.867  | 0.000     | 0.000     | 0.000      | 0.000     |
| 18    | 0   | 18   | 0   | 0   | 0   | POST   | /api/app/payment-methods        | 0.051 | 2.205 | 21.954   | 1.220 | 2.155 | 2.205 | 2.205 | 1.029  | 0.000     | 0.000     | 0.000      | 0.000     |
| 164   | 0   | 90   | 0   | 0   | 74  | GET    | /api/internal/matching          | 0.001 | 2.489 | 20.741   | 0.126 | 0.306 | 0.911 | 1.878 | 0.350  | 0.000     | 166.000   | 12284.000  | 74.902    |
| 11    | 0   | 11   | 0   | 0   | 0   | GET    | /api/owner/sales                | 0.133 | 0.974 | 6.972    | 0.634 | 0.916 | 0.974 | 0.974 | 0.229  | 410.000   | 8997.000  | 13611.000  | 1237.364  |
| 38    | 0   | 38   | 0   | 0   | 0   | POST   | /api/chair/rides/[^/]+/status   | 0.053 | 0.277 | 5.862    | 0.154 | 0.201 | 0.240 | 0.277 | 0.045  | 0.000     | 0.000     | 0.000      | 0.000     |
| 35    | 0   | 35   | 0   | 0   | 0   | GET    | /api/app/rides                  | 0.003 | 0.345 | 5.002    | 0.143 | 0.309 | 0.312 | 0.345 | 0.092  | 12.000    | 2146.000  | 10813.000  | 308.943   |
| 28    | 0   | 28   | 0   | 0   | 0   | POST   | /api/app/rides                  | 0.088 | 0.250 | 4.636    | 0.166 | 0.233 | 0.244 | 0.250 | 0.052  | 51.000    | 52.000    | 1448.000   | 51.714    |
| 12    | 0   | 12   | 0   | 0   | 0   | POST   | /api/app/rides/[^/]+/evaluation | 0.218 | 0.588 | 4.108    | 0.342 | 0.505 | 0.588 | 0.588 | 0.110  | 30.000    | 30.000    | 360.000    | 30.000    |
| 32    | 0   | 32   | 0   | 0   | 0   | POST   | /api/app/rides/estimated-fare   | 0.002 | 0.155 | 1.910    | 0.060 | 0.103 | 0.141 | 0.155 | 0.037  | 26.000    | 29.000    | 883.000    | 27.594    |
| 3     | 0   | 1    | 0   | 0   | 2   | POST   | /api/initialize                 | 0.001 | 1.769 | 1.770    | 0.590 | 1.769 | 1.769 | 1.769 | 0.834  | 19.000    | 166.000   | 351.000    | 117.000   |
| 18    | 0   | 18   | 0   | 0   | 0   | POST   | /api/app/users                  | 0.008 | 0.156 | 0.926    | 0.051 | 0.149 | 0.156 | 0.156 | 0.053  | 86.000    | 86.000    | 1548.000   | 86.000    |
| 21    | 0   | 21   | 0   | 0   | 0   | POST   | /api/chair/chairs               | 0.007 | 0.118 | 0.368    | 0.018 | 0.044 | 0.044 | 0.118 | 0.025  | 75.000    | 75.000    | 1575.000   | 75.000    |
| 1     | 0   | 1    | 0   | 0   | 0   | GET    | /api/owner/sales?               | 0.188 | 0.188 | 0.188    | 0.188 | 0.188 | 0.188 | 0.188 | 0.000  | 9163.000  | 9163.000  | 9163.000   | 9163.000  |
| 5     | 0   | 5    | 0   | 0   | 0   | POST   | /api/owner/owners               | 0.008 | 0.010 | 0.045    | 0.009 | 0.010 | 0.010 | 0.010 | 0.001  | 125.000   | 125.000   | 625.000    | 125.000   |
+-------+-----+------+-----+-----+-----+--------+---------------------------------+-------+-------+----------+-------+-------+-------+-------+--------+-----------+-----------+------------+-----------+
```

- 各テーブルに対するクエリ状況を確認
- スロークエリの確認

## Fix

### /api/chair/notification

- みるとN+1になっているところはなさそう
- スロークエリの結果とも照らし合わせると、`ride_statuses`テーブルへのSELECT, `rides`テーブルへのSELECTが遅いかつ(NO INDEXになっていることがわかる)

score: 2387

スロークエリで出力されていた`rides`, `ride_statuses`へのクエリがNO INDEXになっていないことを確認できた

### ついでにindexの追加

- `chair_locations`もindexが使われていないクエリが複数(about 500)走っているので
  - score: 2562
- `chairs`もindexが使われていないクエリが複数走っているため追加
  - score: 3235
- `rides`はchair_id, updated_atの複合indexに加えて、user_id, created_atで検索されることも多いのでそっちにも追加
  - score: 3638
- `coupons`もindexgが使われていないクエリが複数走っているため追加
  - score: 3300

ここまでやると、スロークエリの上位陣にNO_INDEXなクエリが存在しなくなる

### N+1の解消

- `get_chair_stats`を解消する
  - score: 3418
  - scoreは上がらないんだけど、topで見ると明らかにmysqldのCPU使用率が下がって他のアプリケーションが動くようになってきたことがわかる
    - 2coreで180近くだったのが80 ~ 90付近になった

### マッチング

- `lib/isuride/internal_handler.rb`のあからさまに改善予備軍のロジックを変更
  - ridesテーブルの最新の1件のみ取得していたところを全権取得するように
    - chair_idがNULL -> マッチングの対象である椅子待ちユーザ
  - score: 3824

**「椅子がマッチされるまでの時間」に対して不満を持たなくなっているところが何よりも重要**

```log
time=20:26:39.404 level=INFO msg=29.3%のライドは椅子がマッチされるまでの時間、97.6%のライドはマッチされた椅子が乗車地点までに掛かる時間、100.0%のライドは椅子の実移動時間に不満がありました
time=20:26:39.404 level=INFO msg=結果 pass=true スコア=3824 種別エラー数=map[26:1]
```
